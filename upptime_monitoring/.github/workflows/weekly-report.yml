name: Weekly Report

on:
  schedule:
    - cron: "0 11 * * 1" # –©–æ–ø–æ–Ω–µ–¥—ñ–ª–∫–∞ –æ–± 11:00 —Ä–∞–Ω–∫—É
  workflow_dispatch:

jobs:
  send-weekly-report:
    runs-on: ubuntu-latest

    steps:
      # –ö–ª–æ–Ω—É—î–º–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ –¥–∞–Ω–∏—Ö Upptime
      - name: Checkout repository
        uses: actions/checkout@v3

      # –ó–±–∏—Ä–∞—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑ –¥–∞–Ω–∏—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
      - name: Generate Weekly Stats
        id: stats
        run: |
          TOTAL_SITES=$(cat .upptimerc.yml | grep 'name:' | wc -l)
          TOTAL_UPTIME=$(cat history/summary.json | jq '[.[].uptime] | add / length')
          AVG_RESPONSE_TIME=$(cat history/summary.json | jq '[.[].responseTime] | add / length')
          echo "TOTAL_SITES=${TOTAL_SITES}" >> $GITHUB_ENV
          echo "TOTAL_UPTIME=${TOTAL_UPTIME}" >> $GITHUB_ENV
          echo "AVG_RESPONSE_TIME=${AVG_RESPONSE_TIME}" >> $GITHUB_ENV

      # –ù–∞–¥—Å–∏–ª–∞—î–º–æ –∑–≤—ñ—Ç —É Telegram
      - name: Send Telegram Message
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TOTAL_SITES: ${{ env.TOTAL_SITES }}
          TOTAL_UPTIME: ${{ env.TOTAL_UPTIME }}
          AVG_RESPONSE_TIME: ${{ env.AVG_RESPONSE_TIME }}
        run: |
          curl -s -X POST https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage \
            -d chat_id=$TELEGRAM_CHAT_ID \
            -d text="‚úÖ Weekly Status Report:
            - Total Monitored Websites: $TOTAL_SITES
            - Average Uptime: $TOTAL_UPTIME%
            - Average Response Time: $AVG_RESPONSE_TIME ms

            üëç All systems are operational. Everything is good!"
